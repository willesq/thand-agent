{{template "header" .}}
 
    <main x-data="workflowApp()" x-init="init()">
        <div class="container" style="width: 100%;">
            <!-- Loading State -->
            <div x-show="loading" style="text-align: center; padding: 2rem;">
                <h1>Loading Workflow...</h1>
                <div class="status-dot connecting" style="width: 2rem; height: 2rem; margin: 1rem auto;"></div>
            </div>
            
            <!-- Error State -->
            <div x-show="error && !loading" style="text-align: center; padding: 2rem;">
                <h1>Error Loading Workflow</h1>
                <p x-text="error"></p>
                <button @click="fetchWorkflowStatus('retry')" class="button button-primary">Retry</button>
            </div>
            
            <!-- Workflow Content -->
            <div x-show="execution && !loading && !error">
                <!-- Page Header -->
                <div class="page-header" style="margin-bottom: 1rem;">
                    <h1 x-text="getWorkflowName()"></h1>
                </div>
                
                <!-- Workflow Status Section -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <!-- Status Bubbles -->
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <!-- Current State -->
                            <div x-show="!isWorkflowComplete()" style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: hsl(var(--secondary)); border-radius: 1.5rem; border: 1px solid hsl(var(--border));">
                                    <div style="width: 8px; height: 8px; border-radius: 50%;" 
                                         :style="{ 'background-color': hasCurrentTask() ? '#10b981' : (isWorkflowCompleted() ? '#3b82f6' : '#f59e0b') }"></div>
                                    <span style="font-size: 0.875rem; font-weight: 500;" x-text="hasCurrentTask() ? `Running: ${execution.task}` : (isWorkflowCompleted() ? 'Completed' : (isWorkflowFailed() ? 'Failed' : 'Initializing'))"></span>
                                </div>
                            </div>
                            
                            <!-- Approval Status -->
                            <div x-show="!isWorkflowFailed()" style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 1.5rem; border: 1px solid hsl(var(--border));"
                                     :style="{ 'background-color': getApprovalStatus() === 'approved' ? '#10b98115' : (getApprovalStatus() === 'rejected' ? '#ef444415' : 'hsl(var(--secondary))') }">
                                    <div style="width: 8px; height: 8px; border-radius: 50%;" 
                                         :style="{ 'background-color': getApprovalStatus() === 'approved' ? '#10b981' : (getApprovalStatus() === 'rejected' ? '#ef4444' : '#f59e0b') }"></div>
                                    <span style="font-size: 0.875rem; font-weight: 500;" 
                                          :style="{ 'color': getApprovalStatus() === 'approved' ? '#10b981' : (getApprovalStatus() === 'rejected' ? '#ef4444' : 'hsl(var(--foreground))') }"
                                          x-text="getApprovalStatusText()"></span>
                                </div>
                            </div>
                            
                            <!-- Overall Status -->
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div :class="getWorkflowStatusBadgeClass()" style="padding: 0.5rem 1rem; border-radius: 1.5rem; font-size: 0.875rem; font-weight: 500;">
                                    <span x-text="(execution?.status || 'pending').toUpperCase()"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cancel Button -->
                        <div>
                            <button @click="cancelWorkflow()" 
                                    :disabled="isWorkflowComplete()"
                                    style="padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; border: 1px solid; transition: all 0.2s ease;"
                                    :style="{ 
                                        'background-color': isWorkflowComplete() ? 'hsl(var(--muted))' : '#ef444415',
                                        'border-color': isWorkflowComplete() ? 'hsl(var(--border))' : '#ef4444',
                                        'color': isWorkflowComplete() ? 'hsl(var(--muted-foreground))' : '#ef4444',
                                        'cursor': isWorkflowComplete() ? 'not-allowed' : 'pointer',
                                        'opacity': isWorkflowComplete() ? '0.5' : '1'
                                    }"
                                    :title="isWorkflowComplete() ? 'Cannot cancel completed workflow' : 'Cancel workflow execution'">
                                Cancel Workflow
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <!-- Workflow Progress -->
                    <div style="margin-bottom: 1.5rem;">
                        <template x-if="hasWorkflowTasks()">
                            <div style="position: relative; overflow: hidden; padding: 2rem 0;">
                                <!-- Fade gradients -->
                                <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 2rem; background: linear-gradient(to right, hsl(var(--background)), transparent); z-index: 1; pointer-events: none;"></div>
                                <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 2rem; background: linear-gradient(to left, hsl(var(--background)), transparent); z-index: 1; pointer-events: none;"></div>
                                
                                <!-- Tasks Container -->
                                <div style="display: flex; align-items: center; gap: 1.5rem; justify-content: center; padding: 0 2rem; min-height: 4rem; scrollbar-width: none; -ms-overflow-style: none;">
                                    <template x-for="(task, index) in getTasks()" :key="index">
                                        <div class="workflow-task" 
                                             :class="{ 'workflow-task-current': isCurrentTask(task) }"
                                             style="display: flex; flex-direction: column; align-items: center; min-width: 140px; padding: 1rem; border-radius: 0.5rem; transition: all 0.3s ease; flex-shrink: 0; position: relative;"
                                             :style="{
                                                 'background': isCurrentTask(task) ? `linear-gradient(135deg, ${getTaskColor(task)}15, ${getTaskColor(task)}25)` : (hasTaskExecuted(task) ? 'hsl(var(--card))' : 'hsl(var(--muted))'),
                                                 'border': isCurrentTask(task) ? `2px solid ${getTaskColor(task)}` : '1px solid hsl(var(--border))',
                                                 'box-shadow': isCurrentTask(task) ? `0 0 0 3px ${getTaskColor(task)}50` : 'none',
                                                 'transform': isCurrentTask(task) ? 'scale(1.05)' : 'scale(1)',
                                                 'opacity': !hasTaskExecuted(task) && !isCurrentTask(task) ? '0.6' : '1'
                                             }">
                                            
                                            <!-- Task Number Badge -->
                                            <div style="position: absolute; top: -12px; left: -12px; width: 28px; height: 28px; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 700; z-index: 2;"
                                                 :style="{ 'background-color': isCurrentTask(task) ? getTaskColor(task) : (hasTaskExecuted(task) ? '#10b981' : '#6b7280') }"
                                                 x-text="index">
                                            </div>
                                            
                                            <!-- Task Type Indicator -->
                                            <div style="position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; z-index: 2; border: 2px solid white;"
                                                 :style="{ 'background-color': getTaskColor(task) }">
                                            </div>
                                            
                                            <!-- Status Indicator -->
                                            <div style="margin-bottom: 0.5rem; margin-top: 0.5rem;">
                                                <div :class="getTaskStatusDotClass(task)" 
                                                     :style="{
                                                         'width': isCurrentTask(task) ? '1.25rem' : (hasTaskExecuted(task) ? '1rem' : '1rem'),
                                                         'height': isCurrentTask(task) ? '1.25rem' : (hasTaskExecuted(task) ? '1rem' : '1rem'),
                                                         'border-radius': !hasTaskExecuted(task) && !isCurrentTask(task) ? '50%' : '',
                                                         'background-color': !hasTaskExecuted(task) && !isCurrentTask(task) ? 'hsl(var(--muted-foreground))' : '',
                                                         'opacity': !hasTaskExecuted(task) && !isCurrentTask(task) ? '0.3' : '1'
                                                     }">
                                                </div>
                                            </div>
                                            
                                            <!-- Task Name -->
                                            <div style="text-align: center; margin-bottom: 0.5rem; word-break: break-word; font-size: 0.875rem;"
                                                 :style="{
                                                     'font-weight': isCurrentTask(task) ? '700' : '600',
                                                     'color': isCurrentTask(task) ? getTaskColor(task) : (hasTaskExecuted(task) ? 'hsl(var(--foreground))' : 'hsl(var(--muted-foreground))')
                                                 }"
                                                 x-text="getTaskKey(task)">
                                            </div>
                                            
                                            <!-- Status Badge -->
                                            <div :class="getTaskBadgeClass(task)"
                                                 style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"
                                                 :style="{
                                                     'background-color': isCurrentTask(task) ? getTaskColor(task) : '',
                                                     'color': isCurrentTask(task) ? 'white' : '',
                                                     'font-weight': isCurrentTask(task) ? '600' : '',
                                                     'opacity': !hasTaskExecuted(task) && !isCurrentTask(task) ? '0.6' : '1'
                                                 }"
                                                 x-text="getTaskBadgeText(task)">
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Task Type Legend -->
                        <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #3b82f6;"></div>
                                <span>Call</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #8b5cf6;"></div>
                                <span>Fork</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #10b981;"></div>
                                <span>Emit</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #f59e0b;"></div>
                                <span>Run</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ef4444;"></div>
                                <span>Switch</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #6b7280;"></div>
                                <span>Other</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Step Details -->
                    <template x-if="hasCurrentTask()">
                        <div style="padding: 1.5rem; background-color: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: 0.5rem;">
                            <h4 style="margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">
                                Current Step: <span x-text="execution.task || 'Unknown'"></span>
                            </h4>
                            <div style="display: grid; gap: 1rem;">
                                <!-- Execution Status -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Execution Status:</span>
                                    <div :class="getWorkflowStatusBadgeClass()" x-text="execution?.status"></div>
                                </div>
                                
                                <!-- User Information -->
                                <template x-if="execution && execution.user">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Requesting User:</span>
                                        <div class="badge badge-secondary" x-text="execution.user"></div>
                                    </div>
                                </template>
                                
                                <!-- Role Information -->
                                <template x-if="execution && execution.role">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Role:</span>
                                        <div class="badge badge-secondary" x-text="execution.role"></div>
                                    </div>
                                </template>
                                
                                <!-- Reason -->
                                <template x-if="execution && execution.reason">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Reason:</span>
                                        <div style="font-size: 0.875rem;" x-text="execution.reason"></div>
                                    </div>
                                </template>
                                
                                <!-- Identities List -->
                                <template x-if="execution && execution.identities && execution.identities.length > 0">
                                    <div>
                                        <span style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem; display: block;">Identities:</span>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                            <template x-for="identity in execution.identities" :key="identity">
                                                <div class="badge badge-secondary" x-text="identity"></div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                
                                <!-- Approval Duration -->
                                <template x-if="execution && execution.duration">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Approval Duration:</span>
                                        <div class="badge badge-secondary" x-text="getDuration()"></div>
                                    </div>
                                </template>
                                
                                <!-- Execution Context JSON -->
                                <div>
                                    <details style="margin-top: 1rem;">
                                        <summary style="cursor: pointer; font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">
                                            Execution Context (JSON)
                                        </summary>
                                        <pre style="background-color: hsl(var(--muted)); padding: 1rem; border-radius: 0.375rem; overflow-x: auto; font-size: 0.75rem; margin-top: 0.5rem;"><code x-text="JSON.stringify(execution, null, 2)"></code></pre>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Workflow Complete/Failed States -->
                    <template x-if="!hasCurrentTask()">
                        <div style="padding: 1.5rem; background-color: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: 0.5rem; text-align: center;">
                            <template x-if="isWorkflowCompleted()">
                                <div>
                                    <h4 style="color: hsl(var(--success)); margin-bottom: 0.5rem;">✓ Workflow Complete</h4>
                                    <p style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">All tasks have been executed successfully.</p>
                                    
                                    <div style="margin-top: 1rem;">
                                        <a href="/" class="button button-primary" style="margin-right: 0.5rem;">Back to Home</a>
                                        <a href="/elevate" class="button button-secondary">New Request</a>
                                    </div>
                                    
                                    <!-- Execution Context JSON -->
                                    <details style="margin-top: 1.5rem; text-align: left;">
                                        <summary style="cursor: pointer; font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">
                                            Execution Context (JSON)
                                        </summary>
                                        <pre style="background-color: hsl(var(--muted)); padding: 1rem; border-radius: 0.375rem; overflow-x: auto; font-size: 0.75rem; margin-top: 0.5rem;"><code x-text="JSON.stringify(execution, null, 2)"></code></pre>
                                    </details>
                                </div>
                            </template>
                            
                            <template x-if="isWorkflowFailed()">
                                <div>
                                    <h4 style="color: hsl(var(--destructive)); margin-bottom: 0.5rem;">✗ Workflow Failed</h4>
                                    <p style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">The workflow encountered an error and could not complete.</p>
                                    
                                    <!-- Error Details -->
                                    <template x-if="execution && execution.output">
                                        <div style="margin-top: 1.5rem; text-align: left;">
                                            <div style="background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 1rem;">
                                                <!-- Main Error Message -->
                                                <template x-if="getErrorMessage()">
                                                    <div style="margin-bottom: 1rem;">
                                                        <h5 style="font-size: 0.875rem; font-weight: 600; color: #991b1b; margin-bottom: 0.5rem;">Error Message:</h5>
                                                        <div style="background-color: white; border: 1px solid #fecaca; border-radius: 0.375rem; padding: 0.75rem; font-family: monospace; font-size: 0.875rem; color: #991b1b; white-space: pre-wrap; word-break: break-word;" x-text="formatErrorMessage(getErrorMessage())"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Error Details -->
                                                <template x-if="execution.output.details && execution.output.details.length > 0">
                                                    <div style="margin-bottom: 1rem;">
                                                        <h5 style="font-size: 0.875rem; font-weight: 600; color: #991b1b; margin-bottom: 0.5rem;">Details:</h5>
                                                        <ul style="margin: 0; padding-left: 1.5rem; color: #7f1d1d; font-size: 0.875rem;">
                                                            <template x-for="detail in execution.output.details" :key="detail">
                                                                <li x-text="typeof detail === 'string' ? detail : JSON.stringify(detail)"></li>
                                                            </template>
                                                        </ul>
                                                    </div>
                                                </template>
                                                
                                                <!-- Nested Cause (if present) -->
                                                <template x-if="execution.output.cause">
                                                    <div style="margin-bottom: 1rem; padding-left: 1rem; border-left: 3px solid #fca5a5;">
                                                        <h5 style="font-size: 0.875rem; font-weight: 600; color: #991b1b; margin-bottom: 0.5rem;">Caused by:</h5>
                                                        <div style="background-color: white; border: 1px solid #fecaca; border-radius: 0.375rem; padding: 0.75rem; font-family: monospace; font-size: 0.8125rem; color: #7f1d1d; white-space: pre-wrap; word-break: break-word;" x-text="formatNestedCause(execution.output.cause)"></div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Activity Information (if present) -->
                                                <template x-if="execution.output.activityType || execution.output.activityId">
                                                    <div style="margin-bottom: 1rem; padding: 0.75rem; background-color: white; border: 1px solid #fecaca; border-radius: 0.375rem;">
                                                        <h5 style="font-size: 0.875rem; font-weight: 600; color: #991b1b; margin-bottom: 0.5rem;">Activity Information:</h5>
                                                        <div style="font-size: 0.8125rem; color: #7f1d1d;">
                                                            <template x-if="execution.output.activityType">
                                                                <div><strong>Type:</strong> <span x-text="execution.output.activityType"></span></div>
                                                            </template>
                                                            <template x-if="execution.output.activityId">
                                                                <div><strong>ID:</strong> <span x-text="execution.output.activityId"></span></div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Error Type and Retryable Status (at bottom) -->
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #fecaca; flex-wrap: wrap;">
                                                    <template x-if="getErrorType()">
                                                        <span style="background-color: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;" x-text="getErrorType()"></span>
                                                    </template>
                                                    <template x-if="getErrorRetryable() !== null">
                                                        <span :style="{ 
                                                            'background-color': getErrorRetryable() ? '#fef3c7' : '#d1fae5', 
                                                            'color': getErrorRetryable() ? '#92400e' : '#065f46',
                                                            'padding': '0.25rem 0.75rem',
                                                            'border-radius': '0.25rem',
                                                            'font-size': '0.75rem',
                                                            'font-weight': '600'
                                                        }" x-text="getErrorRetryable() ? 'Non-Retryable' : 'Retryable'"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div style="margin-top: 1rem;">
                                        <a href="/" class="button button-primary" style="margin-right: 0.5rem;">Back to Home</a>
                                        <a href="/elevate" class="button button-secondary">Try Again</a>
                                    </div>
                                    
                                    <!-- Execution Context JSON -->
                                    <details style="margin-top: 1.5rem; text-align: left;">
                                        <summary style="cursor: pointer; font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">
                                            Full Execution Context (JSON)
                                        </summary>
                                        <pre style="background-color: hsl(var(--muted)); padding: 1rem; border-radius: 0.375rem; overflow-x: auto; font-size: 0.75rem; margin-top: 0.5rem;"><code x-text="JSON.stringify(execution, null, 2)"></code></pre>
                                    </details>
                                </div>
                            </template>
                            
                            <template x-if="!isWorkflowCompleted() && !isWorkflowFailed()">
                                <div>
                                    <h4 style="margin-bottom: 0.5rem;">Workflow Initializing</h4>
                                    <p style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">Please wait while the workflow starts...</p>
                                    
                                    <div style="margin-top: 1rem;">
                                        <button @click="fetchWorkflowStatus('refresh')" class="button button-primary">Refresh Status</button>
                                        <a href="/" class="button button-secondary">Back to Home</a>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        
        <!-- Alpine.js styles -->
        <style>
            .workflow-task-current {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% { 
                    transform: scale(1.05);
                    opacity: 1;
                }
                50% { 
                    transform: scale(1.1);
                    opacity: 0.8;
                }
            }
        </style>
    </main>

    <script>
        function workflowApp() {
            return {
                // Initial data from server
                workflowId: '{{.Execution.WorkflowID}}',
                apiBasePath: '{{.Config.GetApiBasePath}}',
                temporalAvailable: {{.Config.GetServices.HasTemporal}},
                
                // Reactive state
                loading: true,
                error: null,
                execution: null,
                workflow: null,
                refreshInterval: null,
                
                // Task type colors mapping
                taskColors: {
                    call: '#3b82f6',
                    fork: '#8b5cf6', 
                    emit: '#10b981',
                    run: '#f59e0b',
                    switch: '#ef4444',
                    listen: '#06b6d4',
                    wait: '#84cc16',
                    set: '#f97316',
                    raise: '#dc2626',
                    try: '#7c2d12',
                    for: '#be185d',
                    do: '#6366f1',
                    default: '#6b7280'
                },
                
                // Initialize the app
                init() {
                    // Load initial data from new structure with error handling
                    try {
                        const executionData = `{{.Execution | toJSON}}`;
                        this.execution = executionData ? JSON.parse(executionData) : {};
                    } catch (e) {
                        console.error('Error parsing execution data:', e);
                        this.execution = {};
                    }
                    
                    try {
                        const workflowData = `{{if .Workflow}}{{.Workflow | toJSON}}{{else}}{}{{end}}`;
                        this.workflow = workflowData ? JSON.parse(workflowData) : {};
                    } catch (e) {
                        console.error('Error parsing workflow data:', e);
                        this.workflow = {};
                    }
                    
                    this.loading = false;

                    console.log('Initialized with data:', {
                        execution: this.execution,
                        workflow: this.workflow,
                        isComplete: this.isWorkflowComplete(),
                        temporalAvailable: this.temporalAvailable
                    });

                    // Start auto-refresh if needed
                    if (this.temporalAvailable && !this.isWorkflowComplete()) {
                        this.fetchWorkflowStatus('init');
                        this.startAutoRefresh();
                    } else if (this.isWorkflowComplete()) {
                        console.log('Workflow already complete - skipping auto-refresh');
                    } else if (!this.temporalAvailable) {
                        console.log('Temporal not available - skipping auto-refresh');
                    }
                },
                
                // Fetch workflow status from API
                async fetchWorkflowStatus(source = 'unknown') {
                    try {
                        console.log(`[${new Date().toISOString()}] Fetching workflow status from: ${source}, ID:`, this.workflowId);
                        const response = await fetch(`${this.apiBasePath}/execution/${this.workflowId}`);
                        
                        if (!response.ok) {
                            throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        console.log('Received workflow data:', data);
                        
                        // Handle response structure: { execution: {...}, workflow: {...} }
                        this.execution = data.execution;
                        this.workflow = data.workflow;
                        this.error = null;

                        console.log('Updated state:', { execution: this.execution, workflow: this.workflow });
                        
                        // Stop auto-refresh if workflow is complete
                        if (this.isWorkflowComplete()) {
                            console.log(`[${new Date().toISOString()}] Workflow complete - stopping auto-refresh`);
                            this.stopAutoRefresh();
                        }
                        
                    } catch (err) {
                        console.error('Error fetching workflow status:', err);
                        this.error = err.message;
                        this.stopAutoRefresh();
                    }
                },
                
                // Auto-refresh management
                startAutoRefresh() {
                    // Don't start if already running
                    if (this.refreshInterval) {
                        console.log('Auto-refresh already running');
                        return;
                    }
                    
                    // Don't start if workflow is already complete
                    if (this.isWorkflowComplete()) {
                        console.log('Workflow already complete - not starting auto-refresh');
                        return;
                    }
                    
                    console.log(`[${new Date().toISOString()}] Starting auto-refresh (polling every 5 seconds)`);
                    this.refreshInterval = setInterval(() => {
                        this.fetchWorkflowStatus('interval');
                    }, 5000);
                },
                
                stopAutoRefresh() {
                    if (this.refreshInterval) {
                        console.log(`[${new Date().toISOString()}] Stopping auto-refresh`);
                        clearInterval(this.refreshInterval);
                        this.refreshInterval = null;
                    }
                },
                
                // Task helper methods
                getTasks() {
                    return this.workflow?.do || [];
                },
                
                getTaskKey(task) {
                    return Object.keys(task)[0];
                },
                
                getTaskDefinition(task) {
                    const key = this.getTaskKey(task);
                    return task[key];
                },
                
                getTaskType(task) {
                    const taskDef = this.getTaskDefinition(task);
                    
                    if (taskDef.call) return 'call';
                    if (taskDef.fork) return 'fork';
                    if (taskDef.emit) return 'emit';
                    if (taskDef.run) return 'run';
                    if (taskDef.switch) return 'switch';
                    if (taskDef.listen) return 'listen';
                    if (taskDef.wait) return 'wait';
                    if (taskDef.set) return 'set';
                    if (taskDef.raise) return 'raise';
                    if (taskDef.try) return 'try';
                    if (taskDef.for) return 'for';
                    if (taskDef.do) return 'do';
                    
                    return 'task';
                },
                
                getTaskColor(task) {
                    const type = this.getTaskType(task);
                    return this.taskColors[type] || this.taskColors.default;
                },
                
                isCurrentTask(task) {
                    // Check if this task matches the current task from execution
                    const taskKey = this.getTaskKey(task);
                    return taskKey === this.execution?.task;
                },
                
                hasTaskExecuted(task) {
                    // Check if task has been executed based on execution history
                    const taskKey = this.getTaskKey(task);
                    return this.execution?.history?.includes(taskKey) || false;
                },
                
                getLatestTaskStatus(task) {
                    // Get status based on execution data
                    const taskKey = this.getTaskKey(task);
                    if (taskKey === this.execution?.task) {
                        return this.execution?.status?.toLowerCase() || 'running';
                    } else if (this.hasTaskExecuted(task)) {
                        return 'completed';
                    }
                    return 'pending';
                },
                
                getTaskStatusDotClass(task) {
                    const isCurrent = this.isCurrentTask(task);
                    const hasExecuted = this.hasTaskExecuted(task);
                    const status = this.getLatestTaskStatus(task);
                    
                    let classes = ['status-dot'];
                    
                    if (isCurrent) {
                        classes.push('connecting');
                    } else if (hasExecuted) {
                        if (status?.toUpperCase() === 'COMPLETED') classes.push('success');
                        else if (status === 'running') classes.push('connecting');
                        else if (status?.toUpperCase() === 'FAILED') classes.push('error');
                    }
                    
                    return classes.join(' ');
                },
                
                getTaskBadgeClass(task) {
                    const isCurrent = this.isCurrentTask(task);
                    const hasExecuted = this.hasTaskExecuted(task);
                    const status = this.getLatestTaskStatus(task);
                    
                    let classes = ['badge'];
                    
                    if (isCurrent) {
                        // Current task uses inline styles
                    } else if (hasExecuted) {
                        if (status?.toUpperCase() === 'COMPLETED') classes.push('badge-success');
                        else if (status === 'running') classes.push('badge-warning');
                        else if (status?.toUpperCase() === 'FAILED') classes.push('badge-error');
                        else classes.push('badge-secondary');
                    } else {
                        classes.push('badge-secondary');
                    }
                    
                    return classes.join(' ');
                },
                
                getTaskBadgeText(task) {
                    const isCurrent = this.isCurrentTask(task);
                    const hasExecuted = this.hasTaskExecuted(task);
                    
                    if (isCurrent) {
                        return 'CURRENT';
                    } else if (hasExecuted) {
                        return this.getLatestTaskStatus(task);
                    } else {
                        return this.getTaskType(task).toUpperCase();
                    }
                },
                
                // Workflow status methods
                getWorkflowStatusBadgeClass() {
                    const status = this.execution?.status;
                    if (status?.toUpperCase() === 'COMPLETED') return 'badge badge-success';
                    if (status?.toUpperCase() === 'FAILED') return 'badge badge-error';
                    return 'badge badge-warning';
                },
                
                isWorkflowCompleted() {
                    const status = this.execution?.status;
                    console.log('Checking completion status:', status);
                    // Check for various possible completion status values
                    const completedStatuses = ['COMPLETED', 'WORKFLOW_EXECUTION_STATUS_COMPLETED', 'SUCCESS', 'SUCCEEDED'];
                    return completedStatuses.some(completedStatus => 
                        status?.toUpperCase() === completedStatus
                    );
                },
                
                isWorkflowFailed() {
                    const status = this.execution?.status;
                    return status?.toUpperCase() === 'FAILED' || status?.toUpperCase() === 'CANCELED' || status?.toUpperCase() === 'TERMINATED';
                },
                
                isWorkflowComplete() {
                    return this.isWorkflowCompleted() || this.isWorkflowFailed();
                },
                
                hasWorkflowTasks() {
                    return this.getTasks().length > 0;
                },
                
                hasCurrentTask() {
                    // Don't show current task if workflow is complete
                    if (this.isWorkflowComplete()) {
                        return false;
                    }
                    return !!this.execution?.task;
                },
                
                getWorkflowName() {
                    return this.workflow?.document?.name || 
                           this.workflow?.name || 
                           this.execution?.name || 
                           this.execution?.id || 
                           this.workflow?.id || 
                           'Unknown Workflow';
                },
                
                // Approval status methods
                getApprovalStatus() {
                    // Check if execution has approval status
                    if (this.execution?.approved === true) {
                        return 'approved';
                    } else if (this.execution?.approved === false) {
                        return 'rejected';
                    }
                    
                    // Default to pending if no approval info found
                    return 'pending';
                },
                
                getApprovalStatusText() {
                    const status = this.getApprovalStatus();
                    switch (status) {
                        case 'approved': return 'Approved';
                        case 'rejected': return 'Rejected';
                        default: return 'Approval Pending';
                    }
                },
                
                // Get duration
                getDuration() {
                    // Duration time in seconds
                    const duration = this.execution?.duration;

                    if (!duration) {
                        return 'Unknown';
                    }

                    const diffSeconds = Math.floor(duration);
                    const diffMinutes = Math.floor(diffSeconds / 60);
                    const diffHours = Math.floor(diffMinutes / 60);
                    const diffDays = Math.floor(diffHours / 24);

                    if (diffDays > 0) {
                        return `${diffDays}d ${diffHours % 24}h ${diffMinutes % 60}m`;
                    } else if (diffHours > 0) {
                        return `${diffHours}h ${diffMinutes % 60}m ${diffSeconds % 60}s`;
                    } else if (diffMinutes > 0) {
                        return `${diffMinutes}m ${diffSeconds % 60}s`;
                    } else {
                        return `${diffSeconds}s`;
                    }
                },
                
                // Get error message (handles both string and object formats)
                getErrorMessage() {
                    if (!this.execution?.output) return '';
                    
                    // If output is a string, return it directly
                    if (typeof this.execution.output === 'string') {
                        return this.execution.output;
                    }
                    
                    // If output is an object with message property
                    if (this.execution.output.message) {
                        return this.execution.output.message;
                    }
                    
                    // Fallback: stringify the output
                    return JSON.stringify(this.execution.output);
                },
                
                // Get error type
                getErrorType() {
                    if (!this.execution?.output) return null;
                    if (typeof this.execution.output === 'object' && this.execution.output.type) {
                        return this.execution.output.type;
                    }
                    return null;
                },
                
                // Get error retryable status
                getErrorRetryable() {
                    if (!this.execution?.output) return null;
                    if (typeof this.execution.output === 'object' && this.execution.output.nonRetryable !== undefined) {
                        return this.execution.output.nonRetryable;
                    }
                    return null;
                },
                
                // Format error message to be more readable
                formatErrorMessage(message) {
                    if (!message) return '';
                    
                    // Break long error messages into multiple lines at logical points
                    let formatted = message
                        .replace(/\. /g, '.\n')  // New line after sentences
                        .replace(/ error: /g, '\nerror: ')  // New line before "error:"
                        .replace(/ message: /g, '\nmessage: ')  // New line before "message:"
                        .replace(/Origin: /g, '\nOrigin: ')  // New line before "Origin:"
                        .replace(/\(type: /g, '\n(type: ');  // New line before type info
                    
                    return formatted;
                },
                
                // Format nested cause recursively as plain text
                formatNestedCause(cause, indent = 0) {
                    if (!cause) return '';
                    
                    let lines = [];
                    const pad = ' '.repeat(indent * 2);

                    if (cause.type) {
                        lines.push(`${pad}Type: ${cause.type}`);
                    }
                    if (cause.message) {
                        lines.push(`${pad}Message: ${cause.message}`);
                    }
                    if (cause.activityType) {
                        lines.push(`${pad}Activity Type: ${cause.activityType}`);
                    }
                    if (cause.activityId) {
                        lines.push(`${pad}Activity ID: ${cause.activityId}`);
                    }
                    if (cause.timeoutType) {
                        lines.push(`${pad}Timeout Type: ${cause.timeoutType}`);
                    }
                    if (cause.cause) {
                        lines.push(`${pad}Caused by:`);
                        lines.push(this.formatNestedCause(cause.cause, indent + 1));
                    }
                    return lines.join('\n');
                },
                
                // Cancel workflow method
                async cancelWorkflow() {
                    if (this.isWorkflowComplete()) {
                        return; // Cannot cancel completed workflows
                    }
                    
                    if (!confirm('Are you sure you want to cancel this workflow? This action cannot be undone.')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${this.apiBasePath}/execution/${this.workflowId}/cancel`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Failed to cancel workflow: ${response.status} ${response.statusText}`);
                        }
                        
                        // Refresh the workflow status immediately
                        await this.fetchWorkflowStatus('cancel');
                        
                    } catch (err) {
                        console.error('Error canceling workflow:', err);
                        alert(`Failed to cancel workflow: ${err.message}`);
                    }
                },
                
                // Cleanup
                destroy() {
                    this.stopAutoRefresh();
                }
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            // Alpine.js will handle cleanup automatically
        });
    </script>

{{template "footer" .}}
