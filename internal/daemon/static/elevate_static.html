{{template "header" .}}
<!-- Choices.js JS (CSS loaded in head.html) -->
<script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>

<main>
    <div class="container">
        <div class="page-header">
            <h1>Static Elevation Request</h1>
            <p>Request temporary elevated privileges for a specific role and reason. Only providers with RBAC support are available for elevation.</p>
        </div>

        <form action="{{.Config.GetApiBasePath}}/elevate" method="GET" class="mt-2 text-left" id="elevate-form">
            <div class="form-section" style="max-width: 600px; margin: 0 auto;">
                
                <!-- Identity Selection (managed by Choices.js, outside Alpine scope) -->
                <h3>Select Identities to Assign Role</h3>
                <div class="choice-wrapper">
                    <select name="identities" id="elevate-identities" multiple>
                        <!-- Options populated dynamically via Choices.js -->
                    </select>
                    <div class="choice-help">
                        Select which users or groups will receive this role. Your current identity is selected by default.
                    </div>
                </div>

                <!-- Provider, Role, Duration, Reason (managed by Alpine.js) -->
                <div style="display: flex; flex-direction: column; gap: 1rem; margin: auto;" 
                     x-data="elevateForm()" 
                     x-init="init()">
                    
                    <!-- Provider Select -->
                    <select name="provider" 
                            x-model="selectedProvider" 
                            @change="onProviderChange()" 
                            required 
                            class="form-select">
                        <option value="">Select a Provider</option>
                        <template x-for="(provider, key) in providers" :key="key">
                            <option :value="key" x-text="provider.name || key"></option>
                        </template>
                    </select>

                    <!-- Role Select -->
                    <select name="role" 
                            x-model="selectedRole" 
                            required 
                            class="form-select" 
                            :disabled="!selectedProvider || loadingRoles" 
                            :style="{ opacity: (!selectedProvider || loadingRoles) ? '0.5' : '1' }">
                        <option value="" x-show="!selectedProvider">Select a Provider First</option>
                        <option value="" x-show="selectedProvider && loadingRoles">Loading roles...</option>
                        <option value="" x-show="selectedProvider && !loadingRoles && Object.keys(roles).length === 0">No roles available</option>
                        <option value="" x-show="selectedProvider && !loadingRoles && Object.keys(roles).length > 0">Select a Role</option>
                        <template x-for="(role, key) in roles" :key="key">
                            <option :value="key" x-text="role.name || key"></option>
                        </template>
                    </select>

                    <!-- Duration Select -->
                    <select name="duration" x-model="duration" required class="form-select">
                        <template x-for="opt in durationOptions" :key="opt.value">
                            <option :value="opt.value" x-text="opt.label"></option>
                        </template>
                    </select>

                    <!-- Reason Textarea -->
                    <textarea name="reason" 
                              x-model="reason" 
                              placeholder="Reason for elevation" 
                              rows="3" 
                              required 
                              class="form-textarea"></textarea>

                    <!-- Submit Button -->
                    <button type="submit" class="button button-primary" :disabled="loading">
                        <span x-show="!loading">Request Elevation</span>
                        <span x-show="loading">Submitting...</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
    (function() {
        'use strict';

        // Constants
        const API_BASE_PATH = '{{.Config.GetApiBasePath}}';
        const CURRENT_USER_EMAIL = '{{if .User}}{{.User.Email}}{{end}}';

        // Choices.js instance (kept outside Alpine to avoid reactivity issues)
        let identityChoicesInstance = null;

        /**
         * Initialize the identity selector using Choices.js
         * This runs on DOMContentLoaded to ensure it executes before Alpine.js
         */
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const prefilledIdentities = urlParams.getAll('identity');

            // Initialize Choices.js for identity multi-select
            identityChoicesInstance = new Choices('#elevate-identities', {
                removeItemButton: true,
                searchEnabled: true,
                placeholder: true,
                placeholderValue: 'Search identities...',
                noResultsText: 'No identities found',
                shouldSort: false,
                searchResultLimit: 50,
                searchFields: ['label', 'value'],
            });

            // Fetch and populate identities
            fetchIdentities(prefilledIdentities);

            // Set up form validation
            setupFormValidation();
        });

        /**
         * Fetch identities from the API and populate the Choices.js selector
         * @param {string[]} prefilledIdentities - Identity IDs to pre-select from URL params
         */
        function fetchIdentities(prefilledIdentities) {
            fetch(`${API_BASE_PATH}/identities`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const choices = parseIdentitiesResponse(data);
                    
                    if (choices.length > 0) {
                        identityChoicesInstance.setChoices(choices, 'value', 'label', true);
                        preselectIdentities(prefilledIdentities);
                    }
                })
                .catch(error => {
                    console.error('Error loading identities:', error);
                });
        }

        /**
         * Parse the identities API response into Choices.js format
         * @param {Object} data - API response data
         * @returns {Array} Formatted choices array
         */
        function parseIdentitiesResponse(data) {
            const choices = [];
            
            if (data && data.identities && Array.isArray(data.identities)) {
                data.identities.forEach(identity => {
                    const label = identity.label 
                        ? `${identity.label} (${identity.id})` 
                        : identity.id;

                    const type = identity.user ? 'user' : (identity.group ? 'group' : 'unknown');

                    choices.push({
                        value: identity.id,
                        label: label,
                        customProperties: { type },
                    });
                });
            }
            
            return choices;
        }

        /**
         * Pre-select identities based on URL params or current user
         * @param {string[]} prefilledIdentities - Identity IDs from URL params
         */
        function preselectIdentities(prefilledIdentities) {
            if (prefilledIdentities.length > 0) {
                // Pre-select identities from URL params
                prefilledIdentities.forEach(identity => {
                    identityChoicesInstance.setChoiceByValue(identity);
                });
            } else if (CURRENT_USER_EMAIL) {
                // Fall back to pre-selecting current user
                identityChoicesInstance.setChoiceByValue(CURRENT_USER_EMAIL);
            }
        }

        /**
         * Set up form validation to ensure at least one identity is selected
         */
        function setupFormValidation() {
            const form = document.getElementById('elevate-form');
            
            form.addEventListener('submit', function(event) {
                const selectedIdentities = identityChoicesInstance 
                    ? identityChoicesInstance.getValue() 
                    : [];
                
                if (selectedIdentities.length === 0) {
                    event.preventDefault();
                    alert('Please select at least one identity to assign the role to');
                    return false;
                }
            });
        }

        /**
         * Alpine.js component for the elevation form
         * Handles provider/role selection with dynamic loading
         */
        window.elevateForm = function() {
            return {
                // Reactive state
                providers: {},
                roles: {},
                selectedProvider: '',
                selectedRole: '',
                duration: 'PT1M',
                reason: '',
                loading: false,
                loadingRoles: false,
                
                // Configuration
                apiBasePath: API_BASE_PATH,
                
                // URL params for pre-filling
                prefilledProviders: [],
                prefilledRoles: [],

                // Duration options
                durationOptions: [
                    { value: 'PT1M', label: '1 Minute' },
                    { value: 'PT5M', label: '5 Minutes' },
                    { value: 'PT15M', label: '15 Minutes' },
                    { value: 'PT30M', label: '30 Minutes' },
                    { value: 'PT1H', label: '1 Hour' },
                    { value: 'PT4H', label: '4 Hours' },
                    { value: 'PT8H', label: '8 Hours' },
                ],

                /**
                 * Initialize the Alpine component
                 */
                init() {
                    this.parseUrlParams();
                    this.loadProviders();
                },

                /**
                 * Parse URL query parameters for form pre-filling
                 */
                parseUrlParams() {
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    this.prefilledProviders = urlParams.getAll('provider');
                    this.prefilledRoles = urlParams.getAll('role');
                    
                    const prefilledReason = urlParams.get('reason');
                    const prefilledDuration = urlParams.get('duration');

                    if (prefilledReason) {
                        this.reason = prefilledReason;
                    }

                    if (prefilledDuration) {
                        const isValidDuration = this.durationOptions.some(opt => opt.value === prefilledDuration);
                        if (isValidDuration) {
                            // Use $nextTick to ensure options are rendered before setting value
                            this.$nextTick(() => {
                                this.duration = prefilledDuration;
                            });
                        }
                    }
                },

                /**
                 * Load available providers from the API
                 */
                async loadProviders() {
                    try {
                        const response = await fetch(`${this.apiBasePath}/providers?capability=rbac`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        this.providers = data.providers || {};

                        // Pre-select provider from URL params if valid
                        if (this.prefilledProviders.length > 0) {
                            const providerToSelect = this.prefilledProviders[0];
                            if (this.providers[providerToSelect]) {
                                this.selectedProvider = providerToSelect;
                                await this.loadRoles();
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching providers:', error);
                    }
                },

                /**
                 * Handle provider selection change
                 */
                async onProviderChange() {
                    this.selectedRole = '';
                    this.roles = {};
                    
                    if (this.selectedProvider) {
                        await this.loadRoles();
                    }
                },

                /**
                 * Load roles for the selected provider
                 */
                async loadRoles() {
                    if (!this.selectedProvider) return;
                    
                    this.loadingRoles = true;
                    
                    try {
                        const response = await fetch(`${this.apiBasePath}/roles?provider=${encodeURIComponent(this.selectedProvider)}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        this.roles = data.roles || {};

                        this.preselectRole();
                    } catch (error) {
                        console.error('Error fetching roles:', error);
                    } finally {
                        this.loadingRoles = false;
                    }
                },

                /**
                 * Pre-select role from URL params
                 * Matches by key first, then by name (case-insensitive)
                 */
                preselectRole() {
                    if (this.prefilledRoles.length === 0) return;
                    
                    const roleToSelect = this.prefilledRoles[0];
                    
                    // Try exact key match first
                    if (this.roles[roleToSelect]) {
                        this.selectedRole = roleToSelect;
                        return;
                    }
                    
                    // Try case-insensitive name match
                    const roleKey = Object.keys(this.roles).find(key => {
                        const role = this.roles[key];
                        return role.name && role.name.toLowerCase() === roleToSelect.toLowerCase();
                    });
                    
                    if (roleKey) {
                        this.selectedRole = roleKey;
                    }
                }
            };
        };
    })();
    </script>
</main>
{{template "footer" .}}
