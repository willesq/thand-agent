{{template "header" .}}
    <style>
        [x-cloak] { display: none !important; }
    </style>
    <script>
        function authCallback() {
            return {
                state: 'loading',
                loadingMessage: 'Registering your session...',
                retryCount: 0,
                maxRetries: 2,
                sessionCopied: false,
                commandCopied: false,
                showCommand: false,
                callback: '{{.Auth.Callback}}',
                provider: '{{.Auth.Provider}}',
                code: '{{.Auth.Code}}',
                session: '{{.Session.GetEncodedLocalSession}}',
                command: 'thand sessions register --login-server {{.LoginServer}} --provider {{.Auth.Provider}}',

                async init() {
                    await this.registerSession();
                },

                async registerSession() {
                    try {
                        // Get API base apiBasePath from config endpoint
                        const configResponse = await fetch(`${this.callback}/.well-known/api-configuration`);
                        if (!configResponse.ok) {
                            throw new Error(`API configuration check failed: ${configResponse.status} ${configResponse.statusText}`);
                        }
                        const configData = await configResponse.json();
                        let apiBasePath = configData.apiBasePath || '/api/v1';
                        apiBasePath = apiBasePath.replace(/^\/+/, '').replace(/\/+$/, '');

                        // Register session
                        const response = await fetch(`${this.callback}/${apiBasePath}/sessions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                provider: this.provider,
                                code: this.code,
                                session: this.session,
                            })
                        });

                        if (response.ok) {
                            this.state = 'success';
                        } else {
                            throw new Error(`Registration failed: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error('Registration error:', error);
                        this.handleRegistrationError();
                    }
                },

                handleRegistrationError() {
                    this.retryCount++;
                    
                    if (this.retryCount <= this.maxRetries) {
                        this.loadingMessage = `Registration failed. Retrying (${this.retryCount}/${this.maxRetries})...`;
                        setTimeout(() => {
                            this.registerSession();
                        }, 2000);
                    } else {
                        this.state = 'error';
                    }
                },

                makeElevationRequest() {
                    window.location.href = '/elevate';
                },

                async copySession() {
                    try {
                        await navigator.clipboard.writeText(this.session);
                        this.sessionCopied = true;
                        setTimeout(() => {
                            this.sessionCopied = false;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy session: ', err);
                    }
                },

                async copyCommand() {
                    try {
                        await navigator.clipboard.writeText(this.command);
                        this.commandCopied = true;
                        setTimeout(() => {
                            this.commandCopied = false;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy command: ', err);
                    }
                }
            }
        }
    </script>

    <main x-data="authCallback()" x-init="init()">
        <div class="container">
            <div class="page-header">
                <h1>Authentication Complete</h1>
            </div>
                
            <!-- Loading State -->
            <div class="auth-result-card" x-show="state === 'loading'">
                <div class="session-status">
                    <div class="status-indicator">
                        <div class="status-dot connecting"></div>
                        <span x-text="loadingMessage"></span>
                    </div>
                    <div class="status-details">
                        Creating secure session with local agent
                    </div>
                </div>
            </div>

            <!-- Success State -->
            <div class="auth-result-card" x-show="state === 'success'" x-cloak>
                <div class="session-status">
                    <div class="status-indicator">
                        <div class="status-dot success"></div>
                        <span>Session registered successfully!</span>
                    </div>
                    <div class="status-details">
                        Your authentication session is now active and ready to use.
                    </div>
                </div>

                <div class="success-content">
                    <h3>What's Next?</h3>
                    <p>Your session is ready. You can now return to your application or test an elevation request.</p>
                    
                    <div class="action-buttons">
                        <button class="button button-primary" @click="makeElevationRequest()">
                            Make Elevation Request
                        </button>
                        <button class="button button-secondary" @click="showCommand = !showCommand" x-text="showCommand ? 'Hide Command' : 'Show Command'">
                        </button>
                        <button class="button button-secondary" @click="window.close()">
                            Close Window
                        </button>
                    </div>

                </div>
            </div>

            <!-- Error State -->
            <div class="auth-result-card" x-show="state === 'error'" x-cloak>
                <div class="session-status">
                    <div class="status-indicator">
                        <div class="status-dot error"></div>
                        <span>Unable to register session automatically</span>
                    </div>
                    <div class="status-details">
                        Please use the command below to manually register your session.
                    </div>
                </div>
            </div>

            <!-- Manual Session Registration Section (shown for error state or when Show Command is clicked) -->
            <div class="auth-result-card" x-show="state === 'error' || showCommand" x-cloak style="margin-top: 1rem;">
                <div class="manual-instructions">
                    <h4>Manual Session Registration</h4>
                    <p>Run this command in your terminal:</p>
                    <div class="code-block">
                        <code>thand sessions register --login-server {{.LoginServer}} --provider {{.Auth.Provider}}</code>
                        <button class="copy-button" @click="copyCommand()">
                            <template x-if="!commandCopied">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </template>
                            <template x-if="commandCopied">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"></polyline></svg>
                            </template>
                        </button>
                    </div>
                    <p class="status-details" style="margin-top: 0.5rem;">You will be prompted to enter the session token shown below.</p>
                </div>
                <div class="auth-code-section">
                    <h3>Session Token</h3>
                    <div class="code-display">
                        <span x-text="session" style="word-break: break-all;"></span>
                        <button class="copy-button" @click="copySession()">
                            <template x-if="!sessionCopied">
                                <span>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    Copy
                                </span>
                            </template>
                            <template x-if="sessionCopied">
                                <span>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"></polyline></svg>
                                    Copied!
                                </span>
                            </template>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
{{template "footer" .}}
