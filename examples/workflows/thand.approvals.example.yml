version: "1.0"
workflows:
  slack_approval:
    description: Access to AWS resources
    # Set which authentication is used to auth the users request
    # before the workflow is run
    authentication: google_oauth2
    enabled: true
    workflow:
      # schedule:
      #   after: ${ .duration }
      #  
      document:
        dsl: "1.0.0-alpha5"
        namespace: "thand"
        name: "slack-approval-workflow"
        version: "1.0.0"
      # The input is the elevate request object.
      do:
        - validate:
            # Firstly, check that the following is valid:
            # If with not provided then just staticlly validate it
            # if LLM specified then we can use AI to validate the request
            thand: validate
            with:
              validator: static
            then: approvals
        - approvals:
            thand: approvals

            # Set the next state based on approval decisions
            on:
              approved: authorize
              denied: denied

            with:

              approvals: 1 # number of approvals required
              selfApprove: true # can the requester approve their own request
              # 1. The thand notifier simplifies multiple workflow steps down
              #    to a single call.
              #    Slack - Sends request to channel
              #    Email - Sends request via email
              # 2. The user can request callbacks to validate the notify request
              #    If the admin really wants to here they can do n-of-m
              #    or more advanced notifications.
              # 3. If a user really wants they can implement the slack or mailer
              #    directly. The user can also just re-quest the notify step to
              #    notify several providers
              notifiers:
                email:
                  provider: email
                  to: ${ $context.identities // [$context.user.email] }
                  # Message is optional, if not provided a default message will be used
                  message: >
                    ${ "The user \($context.user.name) is requesting access." }
            
            # If approvals not met then deny the request
            then: denied
        - authorize:
            # Authorize the user for the requested role
            thand: authorize
            with:
              revocation: revoke
              notifiers:
                slack:
                  provider: slack
                  to: C0123456789
                  message: >
                    You have been granted access.
                email:
                  provider: email
                  to: ${ $context.identities // [$context.user.email] }
                  message: >
                    You have been granted access.

            then: monitor
        - monitor:
            thand: monitor
            with:
              monitor: llm
              threshold: 10
            then: revoke
        - revoke:
            thand: revoke
            with:
              notifiers:
                email:
                  provider: email
                  to: ${ $context.user.email }
                  message: >
                    ${ "Revoking access for user \($context.user.name)." }
                slack:
                  provider: slack
                  to: ${ $context.user.email }
                  message: >
                    Access has been revoked.
            then: end
        - denied:
            thand: notify
            with:
                # provider: slack
              provider: email
              to: ${ $context.user.email }
              message: >
                ${ "\($context.user.name) your access request has been denied" }
            then: end # finishes the workflow
