version: "1.0"
workflows:
  slack_approval:
    description: Access to AWS resources
    # Set which authentication is used to auth the users request
    # before the workflow is run
    authentication: google_oauth2
    enabled: true
    workflow:
      # schedule:
      #   after: ${ .duration }
      #  
      document:
        dsl: "1.0.0-alpha5"
        namespace: "thand"
        name: "slack-approval-workflow"
        version: "1.0.0"
      # The input is the elevate request object.
      do:
        - validate:
            # Firstly, check that the following is valid:
            # If with not provided then just staticlly validate it
            # if LLM specified then we can use AI to validate the request
            thand: validate
            with:
              validator: static
            then: approvals
        - approvals:
            thand: approvals

            # Set the next state based on approval decisions
            on:
              approved: authorize
              denied: denied

            with:

              approvals: 1 # number of approvals required
              selfApprove: false # can the requester approve their own request
              # 1. The thand notifier simplifies multiple workflow steps down
              #    to a single call.
              #    Slack - Sends request to channel
              #    Email - Sends request via email
              # 2. The user can request callbacks to validate the notify request
              #    If the admin really wants to here they can do n-of-m
              #    or more advanced notifications.
              # 3. If a user really wants they can implement the slack or mailer
              #    directly. The user can also just re-quest the notify step to
              #    notify several providers
              notifier:
                provider: slack
                to: C0123456789
                message: >
                  ${ "The user \($context.user.name) is requesting access." }
            
            then: denied
        - authorize:
            # Authorize the user for the requested role
            thand: authorize
            # with:
            #   revocation: revoke # which step to call to revoke access
            then: monitor
        - monitor:
            thand: monitor
            with:
              monitor: llm
              threshold: 10
            then: revoke
        - revoke:
            thand: revoke
            with:
              reason: "Access no longer needed"
            then: finished
        - denied:
            call: slack.postMessage
            with:
              provider: slack
              to: C0123456789
              message:
                text: "Access request denied"
            then: revoke
        - finished:
            call: slack.postMessage
            with:
              provider: slack
              to: C0123456789
              message:
                text: "Access revoked for user due to inactivity or workflow violation"
                blocks:
                  - type: section
                    text: "User access has been revoked"
                  - type: context
                    elements:
                      - type: mrkdwn
                        text: >
                          User: ${ .user } Reason: ${ .reason }

            then: end # finishes the workflow
